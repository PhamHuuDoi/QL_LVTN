extends ../../layouts/default.pug

block main
  h3.text-primary.mb-3= isEdit ? "S·ª¨A H·ªòI ƒê·ªíNG" : "T·∫†O H·ªòI ƒê·ªíNG"

  form#hoiDongForm(
    method="POST",
    action= isEdit ? `/admin/hoidong/${hoidong._id}/edit` : "/admin/hoidong/create"
  )

    // ===== T√äN H·ªòI ƒê·ªíNG =====
    .form-group
      label T√™n h·ªôi ƒë·ªìng
      if isEdit
        input.form-control(type="text", value=hoidong.tenhd, readonly)
      else
        input.form-control(type="text", name="tenhd", required)

    // ===== M√î T·∫¢ =====
    .form-group
      label M√¥ t·∫£
      textarea.form-control(name="mota", rows="2") #{hoidong && hoidong.mota ? hoidong.mota : ""}
    .form-group
      label Ng√†y b·∫£o v·ªá
      input.form-control(
        type="date",
        name="ngaybv",
        required,
        value=(hoidong && hoidong.ngaybv ? hoidong.ngaybv.toISOString().substring(0,10) : "")
      )

    .form-group
      label Ph√≤ng h·ªôi ƒë·ªìng
      input.form-control(
        type="text",
        name="phonghd",
        required,
        value=(hoidong && hoidong.phonghd ? hoidong.phonghd : "")
      )

    // ===== L·∫§Y CHI TI·∫æT (KHI EDIT) =====
    - const ct = chitiets ? chitiets.find(c => c.chucvu === "Ch·ªß t·ªãch") : null
    - const tk = chitiets ? chitiets.find(c => c.chucvu === "Th∆∞ k√Ω") : null
    - const uvs = chitiets ? chitiets.filter(c => c.chucvu === "·ª¶y vi√™n") : []

    // ===== CH·ª¶ T·ªäCH =====
    .form-group
      label Ch·ªß t·ªãch
      select.form-control(name="chutich", id="chutichSelect", required)
        option(value="") -- Ch·ªçn --
        each gv in gvs
          option(
            value=gv._id,
            selected=(ct && ct.gv_id && ct.gv_id._id.toString() === gv._id.toString())
          ) #{gv.magv} - #{gv.hoten}

    // ===== TH∆Ø K√ù =====
    .form-group
      label Th∆∞ k√Ω
      select.form-control(name="thuky", id="thukySelect", required)
        option(value="") -- Ch·ªçn --
        each gv in gvs
          option(
            value=gv._id,
            selected=(tk && tk.gv_id && tk.gv_id._id.toString() === gv._id.toString())
          ) #{gv.magv} - #{gv.hoten}

    // ===== ·ª¶Y VI√äN - D√ôNG JS ƒê·ªÇ TH√äM B·ªöT =====
    .form-group
      label ·ª¶y vi√™n
      #uyvien-wrapper
        .d-flex.mb-2.uyvien-item
          select.form-control.uyvien-select(name="uyviens")
            option(value="") -- Ch·ªçn --
            each gv in gvs
              option(
                value=gv._id,
                selected=(uvs[0] && uvs[0].gv_id && uvs[0].gv_id._id.toString() === gv._id.toString())
              ) #{gv.magv} - #{gv.hoten}
          button.btn.btn-success.ml-2(type="button", id="addUyVienBtn") +

        // üëâ n·∫øu edit v√† c√≥ >1 ·ªßy vi√™n th√¨ render th√™m
        if uvs.length > 1
          each u, i in uvs
            if i > 0
              .d-flex.mb-2.uyvien-item
                select.form-control.uyvien-select(name="uyviens")
                  option(value="") -- Ch·ªçn --
                  each gv in gvs
                    option(
                      value=gv._id,
                      selected=(u.gv_id && u.gv_id._id.toString() === gv._id.toString())
                    ) #{gv.magv} - #{gv.hoten}
                button.btn.btn-danger.ml-2(type="button", class="removeUyVienBtn") -

    // ===== BUTTON =====
    button.btn.btn-success(type="submit")
      = isEdit ? "C·∫≠p nh·∫≠t" : "T·∫°o h·ªôi ƒë·ªìng"
    a.btn.btn-secondary.ml-2(href="/admin/hoidong") H·ªßy

