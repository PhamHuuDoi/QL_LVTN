extends ../../layouts/default.pug

block main
  .container.mt-4
    h3.mb-3.text-primary Phân công phản biện

    table.table.table-bordered.table-hover
      thead.table-dark
        tr
          th Nhóm
          th Tên SV1
          th MSSV1
          th Tên SV2
          th MSSV2
          th Tên đề tài
          th GVHD
          th Giảng viên phản biện
          th Trạng thái

      tbody
        each dt in detais
          tr
            // Nhóm
            td= dt.group || "—"

            // SV1
            td= dt.sv1 ? dt.sv1.ten : "—"
            td= dt.sv1 ? dt.sv1.msvv : "—"

            // SV2
            td= dt.sv2 ? dt.sv2.ten : "—"
            td= dt.sv2 ? dt.sv2.msvv : "—"

            // Tên đề tài
            td= dt.ten

            // Giảng viên hướng dẫn
            td= dt.giangvien_id ? dt.giangvien_id.hoten : "—"

            // Giảng viên phản biện (dropdown luôn hiển thị)
            td
              select.form-select(onchange=`assignPB('${dt._id}', this.value)`)
                option(value="") -- Chọn giảng viên --

                each gv in dt.availablePB
                  option(
                    value=gv._id
                    selected=(dt.phanbien && gv._id.toString() === dt.phanbien.gvphanbien_id._id.toString())
                  ) #{gv.hoten} (#{gv.magv})

            // Trạng thái
            td
              if dt.phanbien
                span.text-success Đã phân công
              else
                span.text-muted Chưa phân công

  // Script xử lý phân công
  script.
    async function assignPB(detai_id, gv_id) {
      if (!gv_id) return;

      const confirm = await Swal.fire({
        title: "Xác nhận?",
        text: "Gán giảng viên phản biện cho đề tài này?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Xác nhận",
        cancelButtonText: "Hủy"
      });

      if (!confirm.isConfirmed) return;

      const res = await fetch("/admin/phancongphanbien/assign", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ detai_id, gvphanbien_id: gv_id })
      });

      const data = await res.json();

      if (data.success) {
        await Swal.fire("Thành công", data.message, "success");
        location.reload();
      } else {
        Swal.fire("Lỗi", data.message, "error");
      }
    }
