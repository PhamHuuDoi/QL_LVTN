extends ../../layouts/default.pug

block main
  h3 NHẬP ĐIỂM PHẢN BIỆN
   .dropdown
        button.btn.btn-outline-primary.dropdown-toggle(type="button" data-toggle="dropdown")
          | Lọc
        ul.dropdown-menu.dropdown-menu-right
          li
            a.dropdown-item(href="?filter=all") Tất cả
          li
            a.dropdown-item(href="?filter=yes") Đã chấm điểm
          li
            a.dropdown-item(href="?filter=no") Chưa chấm điểm
  table.table.table-bordered.table-hover
    thead.table-dark
      tr
        th.text-center Nhóm
        th MSSV
        th Họ tên
        th Lớp
        th Điểm PB
        th Đề tài
        th GVHD
        th Hành động
    tbody
      if rows && rows.length
        // Tạo mảng chứa tất cả sinh viên
        - let allStudents = []
        each row in rows
          - const dt = row.detai || {}
          if dt.sv1
            - allStudents.push({ sv: dt.sv1, detai: dt, dpb: row.dpb, pc: row.pc, daPhanCongHD: row.daPhanCongHD, isSv1: true })
          if dt.sv2
            - allStudents.push({ sv: dt.sv2, detai: dt, dpb: row.dpb, pc: row.pc, daPhanCongHD: row.daPhanCongHD, isSv1: false })
        
        each student in allStudents
          tr
            // Nhóm
            td.text-center
              if student.detai.group && student.detai.group !== "—"
                strong #{student.detai.group}
              else
                span.text-muted -
            
            // MSSV
            td #{student.sv.msvv}
            
            // Họ tên
            td #{student.sv.ten}
            
            // Lớp
            td #{student.sv.lop}
            
            // Điểm PB
            td.text-center
              if student.dpb
                if student.isSv1 && student.dpb.sv1
                  strong.text-primary #{student.dpb.sv1.tongDiem || 0}
                else if !student.isSv1 && student.dpb.sv2
                  strong.text-primary #{student.dpb.sv2.tongDiem || 0}
                else
                  span.text-muted 0
              else
                span.text-muted Chưa có
            
            // Đề tài
            td
              strong #{student.detai.ten}
              // HIỂN THỊ CẢNH BÁO NẾU ĐÃ PHÂN CÔNG HỘI ĐỒNG
              if student.daPhanCongHD
                small.d-block.text-danger
                  | Đã phân công hội đồng
            
            // GVHD
            td #{student.detai.giangvien_id ? student.detai.giangvien_id.hoten : ""}
            
            // Hành động
            td.text-center
              // KIỂM TRA: NẾU ĐÃ PHÂN CÔNG HỘI ĐỒNG THÌ CHUYỂN SANG DETAIL
              if !student.daPhanCongHD
                a.btn.btn-sm.btn-info.mr-1(href=`/giangvien/diemphanbien/form/${student.pc._id}`)
                  | #{student.dpb ? "Sửa" : "Nhập điểm"}
              else
                a.btn.btn-sm.btn-primary.mr-1(href=`/giangvien/diemphanbien/detail/${student.pc._id}`)
                  | #{student.dpb ? "Detail" : "Nhập điểm"}
              
              // NÚT XUẤT WORD (VẪN HIỆN KHI CÓ ĐIỂM)
              if student.dpb
                a.btn.btn-sm.btn-success(href=`/giangvien/diemphanbien/export/${student.sv._id}`)
                  | Xuất Word
      else
        tr
          td(colspan="8", class="text-center text-muted py-4") Không có dữ liệu phản biện.